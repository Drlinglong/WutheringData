# 鸣潮数据增量更新指南

## 📋 概述

本指南将告诉你如何在鸣潮游戏更新后（例如35天后新版本发布），快速增量更新所有数据文件。

**重要**: 本指南适用于已清理并打包到 `final_output` 目录的完整工作区。

## 📦 目录结构

```
final_output/
├── dialogs_zh-Hans_complete.jsonl    # 完整对话数据
├── characters.jsonl                   # 角色信息
├── items.jsonl                        # 物品信息
├── weapons.jsonl                      # 武器信息
├── enemies.jsonl                      # 敌人信息
├── achievements.jsonl                 # 成就信息
├── ConfigDB/                          # 游戏配置文件
├── TextMap/                           # 文本映射
└── scripts/                           # 处理脚本
    ├── complete_dialogue_processor.py
    ├── auto_scan_categories.py
    ├── generate_split_data.py
    ├── analyze_final_quality.py
    ├── extract_characters.py
    ├── extract_items.py
    ├── extract_weapons.py
    ├── extract_enemies.py
    └── extract_achievements.py
```

## 🎯 最终输出文件

处理完成后，你将得到以下6个JSONL文件：

1. **`dialogs_zh-Hans_complete.jsonl`** - 完整对话数据（最大最重要）
2. **`characters.jsonl`** - 角色信息（原rag_input_split.jsonl）
3. **`items.jsonl`** - 物品信息
4. **`weapons.jsonl`** - 武器信息
5. **`enemies.jsonl`** - 敌人信息
6. **`achievements.jsonl`** - 成就信息

## 🚀 更新流程（35天后游戏更新）

### 场景1：完整的游戏更新

**准备步骤**:
1. 进入 `final_output` 目录
2. 备份当前输出文件
3. 替换 `ConfigDB/` 和 `TextMap/` 目录为新版本

**处理步骤**:

```bash
cd final_output

# 1. 检查新数据文件
python scripts/generate_split_data.py check

# 2. 生成新的split数据
python scripts/generate_split_data.py

# 3. 处理所有对话数据（一键完成）
python scripts/complete_dialogue_processor.py

# 4. 验证质量
python scripts/analyze_final_quality.py

# 5. 更新其他数据文件（如果需要）
python scripts/extract_characters.py
python scripts/extract_items.py
python scripts/extract_weapons.py
python scripts/extract_enemies.py
python scripts/extract_achievements.py
```

### 场景2：只更新对话数据

**步骤**:

```bash
cd final_output

# 1. 替换原始数据文件
# 将新版本的 dialogs_zh-Hans.jsonl 复制到对应位置

# 2. 生成split数据
python scripts/generate_split_data.py

# 3. 处理对话数据
python scripts/complete_dialogue_processor.py

# 4. 验证
python scripts/analyze_final_quality.py
```

### 场景3：只更新配置文件

**步骤**:

```bash
cd final_output

# 1. 替换 ConfigDB/ 和 TextMap/ 目录

# 2. 重新处理所有数据
python scripts/complete_dialogue_processor.py

# 3. 验证质量
python scripts/analyze_final_quality.py

# 4. 如果质量下降，运行扫描
python scripts/auto_scan_categories.py
```

## 🔧 脚本说明

### 核心处理脚本

1. **`complete_dialogue_processor.py`** - 主处理器
   - 处理对话数据
   - 建立映射关系
   - 生成最终输出

2. **`generate_split_data.py`** - 生成Split数据
   - 从原始数据生成split格式
   - 自动检测数据文件

3. **`auto_scan_categories.py`** - 扫描分类
   - 识别新的数据模式
   - 生成分类建议

4. **`analyze_final_quality.py`** - 质量分析
   - 检查映射率
   - 验证数据完整性

### 数据提取脚本

1. **`extract_characters.py`** - 提取角色数据
2. **`extract_items.py`** - 提取物品数据
3. **`extract_weapons.py`** - 提取武器数据
4. **`extract_enemies.py`** - 提取敌人数据
5. **`extract_achievements.py`** - 提取成就数据

## 📊 质量指标

处理完成后，你应该看到：

- **映射率**: ≥80%
- **Quest Name覆盖率**: ≥90%
- **Unknown率**: ≤5%

如果指标不达标，运行：
```bash
python scripts/auto_scan_categories.py
```

然后更新 `scripts/complete_dialogue_processor.py` 中的分类系统。

## ⚠️ 常见问题

### 问题1：映射率低于80%

**原因**: 新的flow模式没有被识别

**解决**:
```bash
# 1. 扫描新模式
python scripts/auto_scan_categories.py

# 2. 查看输出，找出新的pattern

# 3. 更新 scripts/complete_dialogue_processor.py 中的分类字典

# 4. 重新处理
python scripts/complete_dialogue_processor.py
```

### 问题2：Quest Name为空

**原因**: TextMap中的键名格式变化

**解决**:
1. 检查 `TextMap/zh-Hans/MultiText.json` 中的键名格式
2. 更新 `scripts/complete_dialogue_processor.py` 中的查找逻辑

### 问题3：文件格式不兼容

**原因**: 游戏更新改变了数据格式

**解决**:
1. 检查新版本的文件格式
2. 更新处理脚本以适配新格式

## 📦 数据备份

更新前，请备份：

```bash
# 备份当前输出
cp dialogs_zh-Hans_complete.jsonl dialogs_zh-Hans_complete.jsonl.bak

# 备份配置文件
cp -r ConfigDB ConfigDB.bak
cp -r TextMap TextMap.bak
```

## 🔄 快速更新流程

如果只是常规更新（不涉及重大变更）：

```bash
cd final_output
python scripts/complete_dialogue_processor.py && python scripts/analyze_final_quality.py
```

## 📝 更新日志

每次更新后，记录：

1. 更新日期
2. 鸣潮版本号
3. 数据变化（新增/删除记录数）
4. 质量指标
5. 遇到的问题和解决方法

## 🎉 成功标志

更新成功的标志：

1. ✅ 所有6个输出文件生成
2. ✅ 映射率 ≥80%
3. ✅ Quest Name覆盖率 ≥90%
4. ✅ 没有异常错误
5. ✅ 数据量有预期变化

---

**更新时间**: 每次鸣潮游戏更新后

**预计耗时**: 5-10分钟

**难度**: ⭐⭐⭐ 中等
