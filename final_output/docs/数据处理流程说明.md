# 鸣潮数据处理流程说明

## 🎯 核心思路

我们采用**双重处理**策略来确保数据质量：
1. **第一阶段提取**：从游戏配置文件中提取原始数据
2. **第二阶段精炼**：对提取的数据进行深度处理和元数据补全

## 📦 最终输出结构

```
final_output/
├── 6个核心数据文件（黄金大便）
│   ├── dialogs_zh-Hans_complete.jsonl  ⭐ 最重要
│   ├── characters.jsonl
│   ├── items.jsonl
│   ├── weapons.jsonl
│   ├── enemies.jsonl
│   └── achievements.jsonl
│
├── scripts/ 处理脚本目录
│   ├── 第一阶段提取脚本
│   │   ├── extract_dialog.py      → WutheringDialog/data/dialogs_zh-Hans.jsonl
│   │   ├── extract_characters.py  → characters.jsonl
│   │   ├── extract_items.py       → items.jsonl
│   │   ├── extract_weapons.py     → weapons.jsonl
│   │   ├── extract_enemies.py     → enemies.jsonl
│   │   └── extract_achievements.py → achievements.jsonl
│   │
│   └── 第二阶段精炼脚本
│       ├── generate_split_data.py         → 生成split格式
│       ├── complete_dialogue_processor.py → 最终处理 ⭐
│       ├── auto_scan_categories.py       → 扫描新模式
│       └── analyze_final_quality.py       → 质量分析
│
└── ConfigDB/ 和 TextMap/（游戏原始配置文件）
```

## 🔄 完整处理流程

### 第一步：从游戏文件生成原始数据（第一阶段提取）

```bash
# 这些脚本从游戏原始文件中提取数据
python extract_dialog.py              # 生成原始的对话数据
python extract_characters.py
python extract_items.py
python extract_weapons.py
python extract_enemies.py
python extract_achievements.py
```

**输出**: 原始数据文件（仅包含基础字段，需要进一步处理）

### 第二步：对原始数据进行精炼（第二阶段精炼）

```bash
# 1. 生成split格式（格式化）
python generate_split_data.py

# 2. 完整处理对话数据（核心步骤）⭐
python complete_dialogue_processor.py

# 3. 验证质量
python analyze_final_quality.py
```

**输出**: 高质量、完整的数据集

## 📊 两个阶段的对比

| 阶段 | 文件名 | 数据质量 | 用途 |
|------|--------|----------|------|
| 第一阶段提取 | `dialogs_zh-Hans.jsonl` | 原始提取数据 | 仅包含doc_id和text，结构简单 |
| 第二阶段精炼 | `dialogs_zh-Hans_complete.jsonl` | 完整处理数据 | 包含完整元数据（quest_id, quest_name, chapter等） |

## 🎯 为什么需要两个阶段？

### 第一阶段（原始提取）
- **目的**: 从游戏配置文件中提取基础数据
- **特点**: 
  - 只包含doc_id和text字段
  - 缺少quest_id、quest_name等元数据
  - 数据结构简单，需要进一步处理

### 第二阶段（深度处理）
- **目的**: 将基础数据转换为高质量、可用的数据集
- **完成的工作**:
  - ✅ 建立完整的quest_id映射关系
  - ✅ 补全quest_name、quest_desc等元数据
  - ✅ 智能分类对话类型
  - ✅ 输出适合RAG使用的格式

## 📝 具体步骤说明

### 当你获得新的游戏文件时：

1. **第一阶段提取**
   ```bash
   python extract_dialog.py
   # 其他extract_*.py脚本
   ```
   生成原始数据文件

2. **第二阶段精炼**
   ```bash
   python generate_split_data.py
   python complete_dialogue_processor.py
   ```
   生成完整数据集

3. **验证质量**
   ```bash
   python analyze_final_quality.py
   ```
   检查映射率、覆盖率等指标

## 💡 数据流转过程

**原始提取数据** = 从游戏配置文件提取的数据
- 格式：`{"doc_id": "...", "text": "..."}`
- 特点：基础字段完整，但缺少元数据信息

**完整处理数据** = 经过深度处理后的数据集
- 格式：完整的结构化数据
- 包含：quest_id、quest_name、chapter_title、section_desc等所有元数据

## 🚀 快速启动

如果你已经有了第一阶段的提取结果：

```bash
# 直接进入第二阶段精炼
cd final_output
python scripts/generate_split_data.py
python scripts/complete_dialogue_processor.py
python scripts/analyze_final_quality.py
```

如果要从零开始：

```bash
# 完整流程
cd wutheringdata
python extract_dialog.py        # 第一阶段：提取原始数据
cd final_output
python scripts/generate_split_data.py    # 第二阶段：生成完整数据集
python scripts/complete_dialogue_processor.py
python scripts/analyze_final_quality.py
```

---

**总结**: 第一阶段是"提取"，第二阶段是"精炼"！确保数据质量达到RAG使用标准。
