# é¸£æ½®å¯¹è¯æ•°æ®å¤„ç†æ“ä½œæ‰‹å†Œ

## æ•°æ®å‡†å¤‡æŒ‡å—

### ğŸ“ åŸå§‹æ•°æ®æ–‡ä»¶
å¤„ç†å‰éœ€è¦ç¡®ä¿ä»¥ä¸‹æ–‡ä»¶å­˜åœ¨ï¼š
- `WutheringDialog/data/dialogs_zh-Hans.jsonl` (åŸå§‹å¯¹è¯æ•°æ®)
- `ConfigDB/PlotHandBookConfig.json` (å‰§æƒ…é…ç½®)
- `ConfigDB/QuestNodeData.json` (ä»»åŠ¡èŠ‚ç‚¹æ•°æ®)
- `TextMap/zh-Hans/MultiText.json` (æ–‡æœ¬æ˜ å°„)

### ğŸ”„ ç”ŸæˆSplitæ•°æ®
**é—®é¢˜**: æ²¡æœ‰ `dialogs_zh-Hans.split.jsonl` æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**:
```bash
python generate_split_data.py
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- è‡ªåŠ¨æŸ¥æ‰¾åŸå§‹æ•°æ®æ–‡ä»¶
- è§£æå¯¹è¯doc_id
- æå–flowä¿¡æ¯
- ç”Ÿæˆsplitæ ¼å¼æ•°æ®

### ğŸ” æ£€æŸ¥åŸå§‹æ•°æ®
```bash
python generate_split_data.py check
```

## ç´§æ€¥æƒ…å†µå¤„ç†æŒ‡å—

### ğŸš¨ ä¸€é”®ä¿®å¤ï¼ˆæ¨èï¼‰
**é—®é¢˜**: æ•°æ®å‡ºé—®é¢˜äº†ï¼Œéœ€è¦å¿«é€Ÿä¿®å¤

**è§£å†³æ–¹æ¡ˆ**:
```bash
python one_click_fix.py
```

è¿™ä¸ªè„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- æ£€æŸ¥æ‰€æœ‰å¿…è¦æ–‡ä»¶
- å¤‡ä»½ç°æœ‰ç»“æœ
- æ‰«ææ•°æ®æ¨¡å¼
- é‡æ–°å¤„ç†æ•°æ®
- è´¨é‡æ£€æŸ¥
- ç”Ÿæˆä¿®å¤æŠ¥å‘Š

### åœºæ™¯1ï¼šæ¸¸æˆæ›´æ–°åéœ€è¦å¢é‡æ›´æ–°
**é—®é¢˜**: åº“æ´›æ›´æ–°äº†æ¸¸æˆï¼Œæ–°å¢äº†å¯¹è¯æ•°æ®ï¼Œéœ€è¦å¤„ç†æ–°æ•°æ®

**è§£å†³æ–¹æ¡ˆ**:
```bash
python incremental_update.py
```

è¿™ä¸ªè„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- æ£€æŸ¥åŸå§‹æ•°æ®æ˜¯å¦æœ‰æ›´æ–°
- æ¯”è¾ƒæ–‡ä»¶å¤§å°å’Œæ—¶é—´æˆ³
- å¤‡ä»½å½“å‰ç»“æœ
- é‡æ–°å¤„ç†æ•°æ®
- éªŒè¯ç»“æœè´¨é‡

### åœºæ™¯2ï¼šå¿«é€Ÿè¯Šæ–­é—®é¢˜
**é—®é¢˜**: ä¸çŸ¥é“æ•°æ®å‡ºäº†ä»€ä¹ˆé—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
```bash
python emergency_diagnosis.py
```

è¿™ä¸ªè„šæœ¬ä¼šæ£€æŸ¥ï¼š
- æ–‡ä»¶å®Œæ•´æ€§
- æ•°æ®æ ¼å¼æ­£ç¡®æ€§
- å¿«é€Ÿè´¨é‡æŒ‡æ ‡
- æä¾›ä¿®å¤å»ºè®®

### åœºæ™¯3ï¼šå¼ºåˆ¶ä¿®å¤
**é—®é¢˜**: æ•°æ®å®Œå…¨åäº†ï¼Œéœ€è¦ä»å¤´å¼€å§‹

**è§£å†³æ–¹æ¡ˆ**:
```bash
python one_click_fix.py fix
```

è¿™ä¼šå¼ºåˆ¶é‡æ–°å¤„ç†æ‰€æœ‰æ•°æ®ã€‚

### åœºæ™¯2ï¼šä»é›¶å¼€å§‹é‡æ–°å¤„ç†
**é—®é¢˜**: åŸå§‹æ•°æ®æŸåæˆ–éœ€è¦å®Œå…¨é‡æ–°å¤„ç†

**è§£å†³æ­¥éª¤**:
1. **æ£€æŸ¥åŸå§‹æ•°æ®å®Œæ•´æ€§**
   ```bash
   # æ£€æŸ¥æ‰€æœ‰å¿…è¦çš„é…ç½®æ–‡ä»¶
   ls -la ConfigDB/PlotHandBookConfig.json
   ls -la ConfigDB/QuestNodeData.json
   ls -la TextMap/zh-Hans/MultiText.json
   ls -la WutheringDialog/data/dialogs_zh-Hans.split.jsonl
   ```

2. **éªŒè¯æ•°æ®æ ¼å¼**
   ```bash
   # æ£€æŸ¥JSONæ ¼å¼æ˜¯å¦æ­£ç¡®
   head -5 WutheringDialog/data/dialogs_zh-Hans.split.jsonl | python -m json.tool
   ```

3. **è¿è¡Œå®Œæ•´å¤„ç†æµç¨‹**
   ```bash
   python complete_dialogue_processor.py
   ```

4. **è´¨é‡æ£€æŸ¥**
   ```bash
   python analyze_final_quality.py
   ```

5. **å¦‚æœè´¨é‡ä¸è¾¾æ ‡ï¼Œè¿è¡Œè¯Šæ–­**
   ```bash
   python auto_scan_categories.py
   ```

## æ•…éšœæ’é™¤æŒ‡å—

### é—®é¢˜1ï¼šæ˜ å°„ç‡ä½äº80%
**ç—‡çŠ¶**: å¤„ç†å®Œæˆåæ˜ å°„ç‡åªæœ‰60-70%

**è¯Šæ–­æ­¥éª¤**:
1. **æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æ›´æ–°**
   ```bash
   # æ£€æŸ¥PlotHandBookConfig.jsonè¡Œæ•°
   wc -l ConfigDB/PlotHandBookConfig.json
   # åº”è¯¥æ¥è¿‘59è¡Œ
   
   # æ£€æŸ¥QuestNodeData.jsonè¡Œæ•°  
   wc -l ConfigDB/QuestNodeData.json
   # åº”è¯¥æ¥è¿‘14,717è¡Œ
   ```

2. **è¿è¡Œæ‰«æè„šæœ¬æ‰¾å‡ºæ–°pattern**
   ```bash
   python auto_scan_categories.py
   ```

3. **æ‰‹åŠ¨æ·»åŠ æ–°åˆ†ç±»**
   - æ‰“å¼€ `complete_dialogue_processor.py`
   - åœ¨ç›¸åº”çš„åˆ†ç±»å­—å…¸ä¸­æ·»åŠ æ–°çš„flow pattern
   - é‡æ–°è¿è¡Œå¤„ç†

### é—®é¢˜2ï¼šå¤§é‡Unknownåˆ†ç±»
**ç—‡çŠ¶**: æœ€ç»ˆç»“æœä¸­è¿˜æœ‰å¤§é‡Unknown

**è§£å†³æ­¥éª¤**:
1. **æ‰¾å‡ºUnknownçš„pattern**
   ```bash
   # åœ¨analyze_final_quality.pyä¸­æ·»åŠ ä»£ç 
   grep -o '"quest_name": "Unknown"' WutheringDialog/data/dialogs_zh-Hans.complete_final.jsonl | wc -l
   ```

2. **åˆ†æUnknownçš„doc_idæ¨¡å¼**
   ```bash
   # æå–Unknownè®°å½•çš„doc_id
   grep '"quest_name": "Unknown"' WutheringDialog/data/dialogs_zh-Hans.complete_final.jsonl | head -20
   ```

3. **æ›´æ–°åˆ†ç±»ç³»ç»Ÿ**
   - æ ¹æ®æ–°çš„patternæ›´æ–°åˆ†ç±»å­—å…¸
   - é‡æ–°è¿è¡Œå¤„ç†

### é—®é¢˜3ï¼šç« èŠ‚ä¿¡æ¯ç¼ºå¤±ä¸¥é‡
**ç—‡çŠ¶**: Chapter Titleè¦†ç›–ç‡ä½äº30%

**è§£å†³æ­¥éª¤**:
1. **æ£€æŸ¥QuestIdæ¨æ–­é€»è¾‘**
   - æ‰“å¼€ `complete_dialogue_processor.py`
   - æ£€æŸ¥ `infer_chapter_id` å‡½æ•°
   - æ ¹æ®æ–°çš„QuestIdèŒƒå›´æ›´æ–°æ¨æ–­è§„åˆ™

2. **æ‰‹åŠ¨æ·»åŠ ç« èŠ‚æ˜ å°„**
   ```python
   # åœ¨main_story_categoriesä¸­æ·»åŠ æ–°çš„ç« èŠ‚æ˜ å°„
   'æ–°ç« èŠ‚pattern': {'chapter': 'æ–°ç« èŠ‚å', 'section': 'æ–°ç« èŠ‚å†…å®¹'},
   ```

## æ—¥å¸¸ç»´æŠ¤æ“ä½œ

### æ¯å‘¨æ£€æŸ¥
1. **æ•°æ®è´¨é‡ç›‘æ§**
   ```bash
   python analyze_final_quality.py
   ```

2. **æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„Unknown pattern**
   ```bash
   grep '"quest_name": "Unknown"' WutheringDialog/data/dialogs_zh-Hans.complete_final.jsonl | wc -l
   ```

### æ¯æœˆç»´æŠ¤
1. **å¤‡ä»½æ‰€æœ‰å¤„ç†è„šæœ¬**
   ```bash
   tar -czf processing_scripts_$(date +%Y%m%d).tar.gz *.py
   ```

2. **æ›´æ–°åˆ†ç±»ç³»ç»Ÿ**
   - è¿è¡Œ `auto_scan_categories.py`
   - æ ¹æ®ç»“æœæ›´æ–°åˆ†ç±»å­—å…¸
   - é‡æ–°å¤„ç†æ•°æ®

## æ€§èƒ½ä¼˜åŒ–

### å¤„ç†å¤§æ–‡ä»¶æ—¶
1. **åˆ†æ‰¹å¤„ç†**
   ```python
   # åœ¨complete_dialogue_processor.pyä¸­ä¿®æ”¹æ‰¹å¤„ç†å¤§å°
   batch_size = 10000  # æ¯æ‰¹å¤„ç†1ä¸‡æ¡
   ```

2. **å†…å­˜ä¼˜åŒ–**
   ```python
   # ä½¿ç”¨ç”Ÿæˆå™¨è€Œä¸æ˜¯åˆ—è¡¨
   def process_dialogues_generator(file_path):
       with open(file_path, 'r', encoding='utf-8') as f:
           for line in f:
               yield json.loads(line.strip())
   ```

### è°ƒè¯•æ¨¡å¼
1. **å¯ç”¨è¯¦ç»†æ—¥å¿—**
   ```python
   import logging
   logging.basicConfig(level=logging.DEBUG)
   ```

2. **ä¿å­˜ä¸­é—´ç»“æœ**
   ```python
   # åœ¨å¤„ç†è¿‡ç¨‹ä¸­ä¿å­˜ä¸­é—´ç»“æœ
   if i % 10000 == 0:
       with open(f'intermediate_result_{i}.jsonl', 'w') as f:
           # ä¿å­˜å½“å‰æ‰¹æ¬¡çš„ç»“æœ
   ```

## ç´§æ€¥ä¿®å¤æµç¨‹

### æ•°æ®æŸåæ—¶
1. **ç«‹å³åœæ­¢å¤„ç†**
2. **æ¢å¤å¤‡ä»½**
   ```bash
   cp WutheringDialog/data/dialogs_zh-Hans.complete_final.jsonl.backup WutheringDialog/data/dialogs_zh-Hans.complete_final.jsonl
   ```

3. **æ£€æŸ¥åŸå§‹æ•°æ®**
   ```bash
   # éªŒè¯åŸå§‹æ–‡ä»¶å®Œæ•´æ€§
   python -c "import json; [json.loads(line) for line in open('WutheringDialog/data/dialogs_zh-Hans.split.jsonl')]"
   ```

4. **é‡æ–°å¤„ç†**
   ```bash
   python complete_dialogue_processor.py
   ```

## ç‰ˆæœ¬æ§åˆ¶

### Gitå·¥ä½œæµ
1. **å¤„ç†å‰æäº¤**
   ```bash
   git add .
   git commit -m "Before processing update"
   ```

2. **å¤„ç†åæäº¤**
   ```bash
   git add WutheringDialog/data/dialogs_zh-Hans.complete_final.jsonl
   git commit -m "Processed dialogue data - $(date)"
   ```

3. **æ ‡ç­¾é‡è¦ç‰ˆæœ¬**
   ```bash
   git tag -a v1.0 -m "Stable processing version"
   ```

## ç›‘æ§è„šæœ¬

### è‡ªåŠ¨åŒ–è´¨é‡æ£€æŸ¥
```python
#!/usr/bin/env python3
# monitor_quality.py

import subprocess
import json
from datetime import datetime

def check_quality():
    result = subprocess.run(['python', 'analyze_final_quality.py'], 
                          capture_output=True, text=True)
    
    # è§£æç»“æœ
    lines = result.stdout.split('\n')
    for line in lines:
        if 'æˆåŠŸæ˜ å°„:' in line:
            mapping_rate = float(line.split('(')[1].split('%')[0])
            if mapping_rate < 80:
                print(f"WARNING: Mapping rate {mapping_rate}% is below 80%")
                return False
    
    print("Quality check passed")
    return True

if __name__ == "__main__":
    check_quality()
```

## å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

### é”™è¯¯1: JSONè§£æé”™è¯¯
```
json.JSONDecodeError: Expecting value: line 1 column 1
```
**è§£å†³**: æ£€æŸ¥æ–‡ä»¶ç¼–ç ï¼Œç¡®ä¿æ˜¯UTF-8

### é”™è¯¯2: å†…å­˜ä¸è¶³
```
MemoryError: Unable to allocate array
```
**è§£å†³**: ä½¿ç”¨åˆ†æ‰¹å¤„ç†æˆ–å¢åŠ è™šæ‹Ÿå†…å­˜

### é”™è¯¯3: æ–‡ä»¶æƒé™é”™è¯¯
```
PermissionError: [Errno 13] Permission denied
```
**è§£å†³**: æ£€æŸ¥æ–‡ä»¶æƒé™ï¼Œç¡®ä¿æœ‰å†™å…¥æƒé™

---

## è„šæœ¬ä½¿ç”¨è¯´æ˜

### æ ¸å¿ƒè„šæœ¬åˆ—è¡¨
1. **generate_split_data.py** - ç”ŸæˆSplitæ•°æ®è„šæœ¬ï¼ˆç¬¬ä¸€æ­¥ï¼‰
2. **one_click_fix.py** - ä¸€é”®ä¿®å¤è„šæœ¬ï¼ˆæ¨èï¼‰
3. **incremental_update.py** - å¢é‡æ›´æ–°è„šæœ¬
4. **emergency_diagnosis.py** - ç´§æ€¥è¯Šæ–­è„šæœ¬
5. **auto_scan_categories.py** - è‡ªåŠ¨æ‰«æåˆ†ç±»è„šæœ¬
6. **complete_dialogue_processor.py** - å®Œæ•´å¤„ç†å™¨
7. **analyze_final_quality.py** - è´¨é‡åˆ†æè„šæœ¬

### å¸¸ç”¨å‘½ä»¤
```bash
# ç¬¬ä¸€æ­¥ï¼šç”ŸæˆSplitæ•°æ®ï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼‰
python generate_split_data.py

# æ£€æŸ¥åŸå§‹æ•°æ®
python generate_split_data.py check

# ä¸€é”®ä¿®å¤ï¼ˆæœ€å¸¸ç”¨ï¼‰
python one_click_fix.py

# å¢é‡æ›´æ–°
python incremental_update.py

# å¿«é€Ÿè¯Šæ–­
python emergency_diagnosis.py

# å¼ºåˆ¶ä¿®å¤
python one_click_fix.py fix

# å¿«é€Ÿæ‰«æ
python one_click_fix.py scan

# æ£€æŸ¥é…ç½®æ›´æ–°
python incremental_update.py check

# è´¨é‡æ£€æŸ¥
python incremental_update.py quality
```

### è„šæœ¬åŠŸèƒ½å¯¹æ¯”
| è„šæœ¬ | ç”¨é€” | é€‚ç”¨åœºæ™¯ | è¿è¡Œæ—¶é—´ |
|------|------|----------|----------|
| generate_split_data.py | ç”ŸæˆSplitæ•°æ® | ç¼ºå°‘splitæ–‡ä»¶ | 2-3åˆ†é’Ÿ |
| one_click_fix.py | ä¸€é”®ä¿®å¤ | æ•°æ®å‡ºé—®é¢˜ | 5-10åˆ†é’Ÿ |
| incremental_update.py | å¢é‡æ›´æ–° | æ¸¸æˆæ›´æ–° | 3-5åˆ†é’Ÿ |
| emergency_diagnosis.py | å¿«é€Ÿè¯Šæ–­ | ä¸çŸ¥é“é—®é¢˜ | 30ç§’ |
| auto_scan_categories.py | æ‰«æåˆ†ç±» | éœ€è¦æ›´æ–°åˆ†ç±» | 1-2åˆ†é’Ÿ |
| complete_dialogue_processor.py | å®Œæ•´å¤„ç† | ä»å¤´å¤„ç† | 5-10åˆ†é’Ÿ |
| analyze_final_quality.py | è´¨é‡åˆ†æ | æ£€æŸ¥ç»“æœ | 1åˆ†é’Ÿ |

**é‡è¦æé†’**: 
- æ¯æ¬¡å¤„ç†å‰éƒ½è¦å¤‡ä»½
- å¤„ç†å¤§æ–‡ä»¶æ—¶ä½¿ç”¨åˆ†æ‰¹å¤„ç†
- å®šæœŸæ£€æŸ¥æ•°æ®è´¨é‡
- ä¿æŒè„šæœ¬çš„ç‰ˆæœ¬æ§åˆ¶
- é‡åˆ°é—®é¢˜å…ˆè¿è¡Œè¯Šæ–­è„šæœ¬
- ä¼˜å…ˆä½¿ç”¨ä¸€é”®ä¿®å¤è„šæœ¬
