# 鸣潮对话数据处理工作流程文档

## 项目背景
处理鸣潮游戏的对话数据，将其从原始的游戏配置文件转换为适合LightRAG知识库的格式。原始数据质量极差，需要大量清洗和映射工作。

## 数据源文件结构

### 1. 原始对话文件
- **文件**: `WutheringDialog/data/dialogs_zh-Hans.split.jsonl`
- **格式**: JSON Lines，每行一个对话记录
- **字段**: `doc_id`, `text`
- **问题**: 缺少上下文信息（任务名、章节、描述等）

### 2. 配置文件（数据屎山）
- **PlotHandBookConfig.json**: 59条记录，映射QuestId到FlowListName
- **QuestNodeData.json**: 14,717条记录，更详细的流程映射
- **MultiText.json**: 192,896条记录，包含所有文本映射
- **Quest.json**: 任务定义（但ID系统不一致）
- **Flow.json**: 对话流程定义

## 核心问题

### 1. ID系统混乱
- QuestId在不同文件中使用不同的ID系统
- TextMap中的键名有动态后缀（如`Quest_139000025_QuestName_0_2`）
- FlowListName与实际对话doc_id不直接匹配

### 2. 数据映射不完整
- 大量对话无法映射到具体的任务ID
- 生态NPC对话、角色线对话、支线任务等缺少分类
- 章节信息严重缺失

### 3. 文本质量差
- 对话缺少上下文信息
- 任务名称、描述、章节标题等关键信息缺失
- 需要从多个配置文件拼凑完整信息

## 处理流程

### 第一阶段：基础映射
1. **解析doc_id**: 从`dialogue_剧情_新剧本测试_1_1_0`提取flow_name、flow_id、state_id、dialogue_id
2. **建立映射**: 从PlotHandBookConfig和QuestNodeData建立flow_name到quest_id的映射
3. **查找任务信息**: 在TextMap中动态查找QuestName、QuestDesc等

### 第二阶段：智能分类
1. **自动扫描**: 扫描所有551个独特的flow模式
2. **分类系统**: 建立生态对话、角色对话、主线剧情、支线任务等分类
3. **回退机制**: 对无法映射的对话提供合理的默认分类

### 第三阶段：内容增强
1. **章节推断**: 根据QuestId模式推断章节信息
2. **描述匹配**: 使用内容匹配找到正确的ChildQuestTip
3. **上下文补全**: 为每个对话添加完整的元数据

## 分类系统

### 生态NPC对话
- 瑝珑第二章: 七丘生态、巴别塔演出、要塞生态等
- 瑝珑第一章: 中曲台地、虎口矿场、荒石高地等
- 特殊类型: 配音生态、氛围NPC、NPC冒泡等

### 角色任务对话
- 瑝珑第二章: 维奥拉、吟霖、寸草心等角色线
- 瑝珑第一章: 余果、刘梦蝶、忌炎等角色线
- 版本更新: V1.2、V2.3等版本角色线

### 主线剧情对话
- 瑝珑台、桑原、乘宵山等主要区域
- 瑝珑之战、瑝珑要塞等关键剧情
- 巴别塔演出、狄斯台地等特殊剧情

### 支线任务对话
- 团团团团转、团子记忆手册等支线
- 布偶小队历险记、猫猫咖啡厅等小游戏
- 灯塔迷航、沉没的历史等探索任务

## 技术实现

### 核心脚本
- **complete_dialogue_processor.py**: 最终完整处理器
- **auto_scan_categories.py**: 自动扫描分类脚本
- **check_quality.py**: 质量检查脚本

### 关键算法
1. **动态键匹配**: 使用正则表达式查找TextMap中的变体键名
2. **内容匹配**: 基于对话内容匹配正确的描述文本
3. **分层分类**: 按优先级尝试不同的分类方法
4. **统计监控**: 实时跟踪映射成功率和质量指标

## 质量指标

### 当前状态
- **总对话数**: 58,488条
- **成功映射**: 46,890条 (80.2%)
- **任务名覆盖**: 0.4% (255条)
- **任务描述覆盖**: 0.4% (255条)
- **章节信息覆盖**: 10.4% (6,075条)
- **子任务提示覆盖**: 69.5% (40,666条)

### 分类统计
- **生态对话**: 3,103条
- **角色对话**: 426条
- **支线任务**: 552条
- **特殊类型**: 1,994条

## 主要挑战

### 1. 库洛程序员的设计问题
- ID系统不统一，导致映射困难
- 配置文件结构复杂，缺少文档
- 数据质量差，大量信息缺失

### 2. 技术难点
- 需要处理551个不同的flow模式
- 动态键名匹配复杂
- 内容匹配需要处理说话人前缀等问题

### 3. 数据完整性
- 19.8%的对话无法映射到quest_id
- 90%以上的对话缺少章节信息
- 需要大量人工分类和回退机制

## 解决方案

### 1. 自动化扫描
- 自动识别所有flow模式
- 基于关键词自动分类
- 生成完整的分类系统

### 2. 智能回退
- 对无法映射的对话提供合理分类
- 使用内容匹配补充缺失信息
- 建立多层次的分类优先级

### 3. 质量监控
- 实时统计映射成功率
- 监控各类别的覆盖情况
- 提供详细的质量报告

## 未来改进

### 1. 数据源优化
- 建议库洛统一ID系统
- 提供更完整的配置文件
- 改善数据质量

### 2. 算法优化
- 改进内容匹配算法
- 优化分类优先级
- 增加更多回退机制

### 3. 监控完善
- 增加更详细的质量指标
- 提供可视化报告
- 建立自动化测试

## 总结

这个项目是一个典型的数据清洗和映射项目，主要挑战来自于原始数据质量差和库洛程序员的设计问题。通过建立完整的分类系统、智能回退机制和质量监控，我们成功将80.2%的对话进行了有效映射，为LightRAG知识库提供了可用的数据。

**关键教训**: 在处理游戏数据时，必须做好数据质量差的准备，建立完善的回退机制和分类系统，同时保持对库洛程序员设计能力的合理期望。

---
*文档生成时间: 2024年*
*处理数据量: 58,488条对话记录*
*映射成功率: 80.2%*
*分类数量: 551个独特flow模式*
